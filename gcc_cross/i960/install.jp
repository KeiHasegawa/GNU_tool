i960 のクロスコンパイル環境

(*) i960
https://ja.wikipedia.org/wiki/Intel_i960

(*) binutils のインストール

% cd /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG
% gunzip -c ../binutils-2.10.1.tar.gz | tar xf -
% mv binutils-2.10.1 binutils-2.10.1.i960-elf
% cd binutils-2.10.1.i960-elf
% ./configure --prefix=/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG --target=i960-elf
% make
...
gcc -DHAVE_CONFIG_H -I. -I. -I. -D_GNU_SOURCE -I. -I. -I../bfd -I./config -I./../include -I./.. -I./../bfd -I./../intl -I../intl -DLOCALEDIR="\"/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/share/locale\""    -g -O2 -W -Wall -c app.c
...
./config/tc-i960.h:181:32: エラー: array type has incomplete element type ‘struct relax_type’
  181 | extern const struct relax_type md_relax_table[];
      |                                ^~~~~~~~~~~~~~

tc.h に relax_type 構造体が宣言されている.

#ifdef USE_MD_RELAX_TABLE
extern const struct relax_type md_relax_table[];
#define TC_GENERIC_RELAX_TABLE md_relax_table
#endif // USE_MD_RELAX_TABLE

のように修正してみた. エラーを回避できているっぽい.

% make install

インストールされたのは

/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-addr2line.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-ar.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-as.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-c++filt.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-gasp.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-ld.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-nm.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-objcopy.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-objdump.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-ranlib.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-readelf.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-size.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-strings.j*
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/bin/i960-elf-strip.j*

だった. .j なしのファイルに変更しておいた.

(*) gcc のインストール

% cd /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG
% bunzip2 -c ../gcc-3.4.4.tar.bz2  | tar xf -
% mv gcc-3.4.4 gcc-3.4.4.i960-elf
% cd gcc-3.4.4.i960-elf
% ./configure --prefix=/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG --target=i960-elf --enable-obsolete
% setenv SHELL /bin/sh
% make all-gcc LANGUAGES="c c++"
...
if [ -f stmp-dirs ]; then true; else touch stmp-dirs; fi
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/xgcc -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/ -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/bin/ -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/lib/ -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/include -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/sys-include -O2  -DIN_GCC -DCROSS_COMPILE   -W -Wall -Wwrite-strings -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition  -isystem ./include   -g  -DIN_LIBGCC2 -D__GCC_FLOAT_NOT_NEEDED -Dinhibit_libc -I. -I. -I. -I./. -I./../include   -DL_muldi3 -c ./libgcc2.c -o libgcc/./_muldi3.o
as: unrecognized option '-AKB'
make[2]: *** [libgcc.mk:8: libgcc/./_muldi3.o] エラー 1


% i960-elf-as -o a.o a.s
% i960-elf-as -o a.o a.s -AKB
% which as
/usr/local/bin/as
% as -o a.o a.s
% as -o a.o a.s -AKB
as: unrecognized option '-AKB'


-AKB オプションは受け付けられているらしい. i960-elf-as でない
/usr/local/bin/as を起動している可能性はある.

specs に問題があるのかと思った.

*invoke_as:
%{!S:-o %|.s |
 i960-elf-as %(asm_options) %m.s %A }
 ^^^^^^^^^^^

*invoke_as:
%{!S:-o %|.s |
 as %(asm_options) %m.s %A }

のようになっている. しかしインストールに問題のなかった

/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.m68hc11-elf/gcc/specs

も同じように

*invoke_as:
%{!S:-o %|.s |
 as %(asm_options) %m.s %A }

のようになっている. xgcc から起動される as をどのように決めているのか
もう少し詳しく調べてみる.

% cd /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.m68hc11-elf/gcc
% ./xgcc -c a.c
% ls -l a.o

勿論正常にできている.

/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.m68hc11-elf/gcc/gcc.c:

      commands[i].pid = pexecute (string, (char *const *) commands[i].argv,

(gdb) p string
$3 = 0x8066d48 "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/lib/gcc/m68hc11-elf/3.4.4/../../../../m68hc11-elf/bin/as"
(gdb) 

なるほど. これがどのように指定されるかはともかくここで起動しているらしい.
そこで binutils のインストールで以下を思い出した:

% ls /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/bin
ar.j*  as.j*  ld.j*  nm.j*  ranlib.j*  strip.j*
%

なるほどこれが原因っぽい. .j のないファイルにリネームしておく.


% cd /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc
% ./xgcc -c a.c
xgcc: installation problem, cannot exec `cc1': そのようなファイルやディレクトリはありません
% set path = ($path /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc )
% ./xgcc -c a.c
% ls -l a.o

できている.

% cd /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf
% make all-gcc LANGUAGES="c c++"
...
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/xgcc -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/ -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/bin/ -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/lib/ -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/include -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/sys-include -O2  -DIN_GCC -DCROSS_COMPILE   -W -Wall -Wwrite-strings -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition  -isystem ./include   -g  -DIN_LIBGCC2 -D__GCC_FLOAT_NOT_NEEDED -Dinhibit_libc -I. -I. -I. -I./. -I./../include   -DL_fixtfdi -c ./libgcc2.c -o libgcc/./_fixtfdi.o
./libgcc2.c: In function `__fixtfdi':
./libgcc2.c:1206: コンパイラ内部エラー: セグメンテーション違反です
Please submit a full bug report,
with preprocessed source if appropriate.
See <URL:http://gcc.gnu.org/bugs.html> for instructions.
make[2]: *** [libgcc.mk:160: libgcc/./_fixtfdi.o] エラー 1
make[2]: ディレクトリ '/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc' から出ます
make[1]: *** [Makefile:1261: stmp-multilib] エラー 2
make[1]: ディレクトリ '/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc' から出ます
make: *** [Makefile:23373: all-gcc] エラー 2

正しいアセンブラを起動できていない問題は回避できたが, 今度は別のバグが
発火している.

gdb から cc1 を起動して再現するか確かめてみた:

M-x gdb
gdb --annotate ./cc1
(gdb) run -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/include -g  -DIN_LIBGCC2 -D__GCC_FLOAT_NOT_NEEDED -Dinhibit_libc -I. -I. -I. -I./. -I./../include   -DL_fixtfdi ./libgcc2.c -o libgcc/./_fixtfdi.o

正常終了している. 再現できていない.

% ls -l libgcc/./_fixtfdi.o

作成できている.

% cd /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf
% make all-gcc LANGUAGES="c c++"
...
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/xgcc -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/ -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/bin/ -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/lib/ -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/include -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/sys-include -O2  -DIN_GCC -DCROSS_COMPILE   -W -Wall -Wwrite-strings -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition  -isystem ./include   -g  -DIN_LIBGCC2 -D__GCC_FLOAT_NOT_NEEDED -Dinhibit_libc -I. -I. -I. -I./. -I./../include   -DL_fixunstfdi -c ./libgcc2.c -o libgcc/./_fixunstfdi.o
./libgcc2.c: In function `__fixunstfdi':
./libgcc2.c:1196: コンパイラ内部エラー: セグメンテーション違反です

% cd gcc
% /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/xgcc -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/ -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/bin/ -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/lib/ -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/include -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/sys-include -O2  -DIN_GCC -DCROSS_COMPILE   -W -Wall -Wwrite-strings -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition  -isystem ./include   -g  -DIN_LIBGCC2 -D__GCC_FLOAT_NOT_NEEDED -Dinhibit_libc -I. -I. -I. -I./. -I./../include   -DL_fixunstfdi -c ./libgcc2.c -o libgcc/./_fixunstfdi.o
./libgcc2.c: In function `__fixunstfdi':
./libgcc2.c:1196: コンパイラ内部エラー: セグメンテーション違反です
Please submit a full bug report,
with preprocessed source if appropriate.
See <URL:http://gcc.gnu.org/bugs.html> for instructions.

これなら再現している.

% /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/xgcc -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/ -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/bin/ -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/lib/ -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/include -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/sys-include -O2  -DIN_GCC -DCROSS_COMPILE   -W -Wall -Wwrite-strings -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition  -isystem ./include   -g  -DIN_LIBGCC2 -D__GCC_FLOAT_NOT_NEEDED -Dinhibit_libc -I. -I. -I. -I./. -I./../include   -DL_fixunstfdi -c ./libgcc2.c -o libgcc/./_fixunstfdi.o -###
/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/specs から spec を読み込んでいます
configure 設定: ./configure --prefix=/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG --target=i960-elf --enable-obsolete
スレッドモデル: single
gcc version 3.4.4
 "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/cc1" "-quiet" "-I." "-I." "-I." "-I./." "-I./../include" "-iprefix" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/../lib/gcc/i960-elf/3.4.4/" "-isystem" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/include" "-isystem" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/bin/include" "-isystem" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/lib/include" "-D__i960_KB" "-D__i960KB__" "-DIN_GCC" "-DCROSS_COMPILE" "-DIN_LIBGCC2" "-D__GCC_FLOAT_NOT_NEEDED" "-Dinhibit_libc" "-DL_fixunstfdi" "-isystem" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/include" "-isystem" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/sys-include" "-isystem" "./include" "./libgcc2.c" "-mka" "-gstabs" "-quiet" "-dumpbase" "libgcc2.c" "-auxbase-strip" "libgcc/./_fixunstfdi.o" "-g" "-O2" "-W" "-Wall" "-Wwrite-strings" "-Wstrict-prototypes" "-Wmissing-prototypes" "-Wold-style-definition" "-o" "/tmp/ccQE7WWr.s"
 "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/bin/as" "--traditional-format" "-AKB" "-o" "libgcc/./_fixunstfdi.o" "/tmp/ccQE7WWr.s"

そこで以下のように起動
(gdb) run "-quiet" "-I." "-I." "-I." "-I./." "-I./../include" "-iprefix" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/../lib/gcc/i960-elf/3.4.4/" "-isystem" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/gcc-3.4.4.i960-elf/gcc/include" "-isystem" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/bin/include" "-isystem" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/lib/include" "-D__i960_KB" "-D__i960KB__" "-DIN_GCC" "-DCROSS_COMPILE" "-DIN_LIBGCC2" "-D__GCC_FLOAT_NOT_NEEDED" "-Dinhibit_libc" "-DL_fixunstfdi" "-isystem" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/include" "-isystem" "/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/i960-elf/sys-include" "-isystem" "./include" "./libgcc2.c" "-mka" "-gstabs" "-quiet" "-dumpbase" "libgcc2.c" "-auxbase-strip" "libgcc/./_fixunstfdi.o" "-g" "-O2" "-W" "-Wall" "-Wwrite-strings" "-Wstrict-prototypes" "-Wmissing-prototypes" "-Wold-style-definition" "-o" "/tmp/ccQE7WWr.s"

これで再現している.

void
output_addr_const (FILE *file, rtx x)
{
  char buf[256];

 restart:
  switch (GET_CODE (x))   ここで x = 0

% rm i960.o
% make cc1

(gdb) run
...

これなら正常終了している.

% cd ..
% make all-gcc LANGUAGES="c c++"

エラーせず. 少しずるいがこれで対処しておく.

% make install-gcc LANGUAGES="c c++"

(*) gdb のインストール

「i960 の gdb」を参照

(*) newlib のインストール

% cd /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/
% gunzip -c ../newlib-1.13.0.tar.gz | tar xf -
% mv newlib-1.13.0 newlib-1.13.0.i960-elf
% cd newlib-1.13.0.i960-elf
% ./configure --prefix=/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG --target=i960-elf
% make
...
i960-elf-gcc -B/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/newlib-1.13.0.i960-elf/i960-elf/soft-float/newlib/ -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/newlib-1.13.0.i960-elf/i960-elf/soft-float/newlib/targ-include -isystem /media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/newlib-1.13.0.i960-elf/newlib/libc/include  -msoft-float -DPACKAGE=\"newlib\" -DVERSION=\"1.13.0\"  -I. -I../../../../.././newlib/libc/stdio  -O2 -DMISSING_SYSCALL_NAMES -fno-builtin    -O2 -g -O2  -O2 -g -O2  -msoft-float -fshort-enums -c ../../../../.././newlib/libc/stdio/vfprintf.c
/tmp/ccfWX3yO.s: Assembler messages:
/tmp/ccfWX3yO.s:2859: Error: Fixup of 6692 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of 6564 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of 4960 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of 4800 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of 4792 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of 5632 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of 4664 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of 4912 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of 4408 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of -4532 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of -4248 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of -4256 too large for field width of 13
/tmp/ccfWX3yO.s:2859: Error: Fixup of -5368 too large for field width of 13
make[7]: *** [Makefile:438: vfprintf.o] エラー 1
make[7]: ディレクトリ '/media/ca850f52-0605-42a7-9fd4-899de9edf461/work/GNU_LANG/newlib-1.13.0.i960-elf/i960-elf/soft-float/newlib/libc/stdio' から出ます
make[6]: *** [Makefile:404: all-recursive] エラー 1

これはおそらくコンパイラのバグっぽい.
とりあえず保留.
